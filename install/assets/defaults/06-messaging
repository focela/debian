#!/command/with-contenv bash
#
# Container Messaging Configuration
# This script configures SMTP settings for the container's email delivery system.
# It sets up default values for connecting to an SMTP server for outgoing mail.
#

set -euo pipefail
IFS=$'\n\t'

#--------------------------------------------------
# Configuration
#--------------------------------------------------

# SMTP server connection settings
SMTP_HOST=${SMTP_HOST:-"postfix-relay"}
SMTP_PORT=${SMTP_PORT:-"25"}
SMTP_DOMAIN=${SMTP_DOMAIN:-"docker"}
SMTP_MAILDOMAIN=${SMTP_MAILDOMAIN:-"local"}

# SMTP security settings
SMTP_TLS=${SMTP_TLS:-"FALSE"}
SMTP_STARTTLS=${SMTP_STARTTLS:-"FALSE"}
SMTP_TLSCERTCHECK=${SMTP_TLSCERTCHECK:-"FALSE"}

# SMTP behavior settings
SMTP_AUTO_FROM=${SMTP_AUTO_FROM:-"FALSE"}

# Additional settings
SMTP_USER=${SMTP_USER:-""}
SMTP_PASS=${SMTP_PASS:-""}
SMTP_AUTH=${SMTP_AUTH:-""}

#--------------------------------------------------
# Helper Functions
#--------------------------------------------------

# Log a message with timestamp
log_message() {
  local level="$1"
  local message="$2"
  local timestamp

  timestamp=$(date +"%Y-%m-%d %H:%M:%S")
  echo "[$timestamp] [MESSAGING] $level: $message" >&2
}

# Validate SMTP configuration
validate_smtp_config() {
  # Check for required host
  if [[ -z "$SMTP_HOST" ]]; then
    log_message "ERROR" "SMTP_HOST is not set"
    return 1
  fi

  # Validate port is numeric
  if ! [[ "$SMTP_PORT" =~ ^[0-9]+$ ]]; then
    log_message "WARNING" "SMTP_PORT is not numeric: $SMTP_PORT, defaulting to 25"
    SMTP_PORT="25"
  fi

  # Validate TLS settings
  if [[ "$SMTP_TLS" != "TRUE" && "$SMTP_TLS" != "FALSE" ]]; then
    log_message "WARNING" "Invalid SMTP_TLS value: $SMTP_TLS, defaulting to FALSE"
    SMTP_TLS="FALSE"
  fi

  if [[ "$SMTP_STARTTLS" != "TRUE" && "$SMTP_STARTTLS" != "FALSE" ]]; then
    log_message "WARNING" "Invalid SMTP_STARTTLS value: $SMTP_STARTTLS, defaulting to FALSE"
    SMTP_STARTTLS="FALSE"
  fi

  # Check for authentication consistency
  if [[ -n "$SMTP_USER" && -z "$SMTP_PASS" ]]; then
    log_message "WARNING" "SMTP_USER is set but SMTP_PASS is empty"
  fi

  # If both user and password are provided, enable authentication
  if [[ -n "$SMTP_USER" && -n "$SMTP_PASS" && -z "$SMTP_AUTH" ]]; then
    log_message "INFO" "Setting SMTP_AUTH to 'on' based on credentials provided"
    SMTP_AUTH="on"
  fi

  return 0
}

# Configure MSMTP if available
configure_msmtp() {
  # Check if msmtp config directory exists
  if [[ ! -d "/etc/msmtp" ]]; then
    log_message "INFO" "MSMTP configuration directory not found, skipping configuration"
    return 0
  fi

  # Skip if messaging backend is not msmtp
  if [[ "${CONTAINER_MESSAGING_BACKEND:-"msmtp"}" != "msmtp" ]]; then
    log_message "INFO" "Messaging backend is not msmtp, skipping MSMTP configuration"
    return 0
  fi

  log_message "INFO" "MSMTP configuration will be generated at container startup"
  return 0
}

#--------------------------------------------------
# Main Execution
#--------------------------------------------------

# Skip configuration if messaging is disabled
if [[ "${CONTAINER_ENABLE_MESSAGING:-TRUE}" != "TRUE" ]]; then
  log_message "INFO" "Messaging is disabled, skipping configuration"
  exit 0
fi

# Validate SMTP configuration
validate_smtp_config || {
  log_message "ERROR" "SMTP configuration validation failed"
  exit 1
}

# Determine messaging backend and configure it
case "${CONTAINER_MESSAGING_BACKEND:-"msmtp"}" in
  "msmtp")
    log_message "INFO" "Using MSMTP as messaging backend"
    configure_msmtp
    ;;
  *)
    log_message "WARNING" "Unknown messaging backend: ${CONTAINER_MESSAGING_BACKEND:-"msmtp"}, defaulting to msmtp"
    CONTAINER_MESSAGING_BACKEND="msmtp"
    configure_msmtp
    ;;
esac

# Log current configuration
log_message "INFO" "SMTP host: $SMTP_HOST:$SMTP_PORT"
log_message "INFO" "TLS enabled: $SMTP_TLS, StartTLS enabled: $SMTP_STARTTLS"
log_message "INFO" "Using domain: $SMTP_DOMAIN, Mail domain: $SMTP_MAILDOMAIN"

# Export all variables for child processes
export SMTP_AUTO_FROM
export SMTP_DOMAIN
export SMTP_HOST
export SMTP_MAILDOMAIN
export SMTP_PORT
export SMTP_STARTTLS
export SMTP_TLS
export SMTP_TLSCERTCHECK
export SMTP_USER
export SMTP_PASS
export SMTP_AUTH
