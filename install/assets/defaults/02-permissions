#!/command/with-contenv bash
#
# Container Permissions Configuration
# This script configures debugging for the container permission system.
# It allows for verbose output when troubleshooting permission issues.
#

set -euo pipefail
IFS=$'\n\t'

#--------------------------------------------------
# Configuration
#--------------------------------------------------

# Debug toggle for permission operations
DEBUG_PERMISSIONS=${DEBUG_PERMISSIONS:-"FALSE"}

#--------------------------------------------------
# Helper Functions
#--------------------------------------------------

# Log message if permission debugging is enabled
log_permission_debug() {
  local message="$1"

  if [[ "${DEBUG_PERMISSIONS}" == "TRUE" ]]; then
    echo "[PERMISSION DEBUG] ${message}" >&2
  fi
}

# Validate that permission-related variables are properly set
validate_permission_settings() {
  # Ensure CONTAINER_ENABLE_PERMISSIONS is defined (from 00-container)
  : "${CONTAINER_ENABLE_PERMISSIONS:?is not set. Check if 00-container is loaded properly}"

  log_permission_debug "Permission settings validated"
  return 0
}

#--------------------------------------------------
# Main Execution
#--------------------------------------------------

# Skip validation if permissions are disabled
if [[ "${CONTAINER_ENABLE_PERMISSIONS:-TRUE}" != "TRUE" ]]; then
  log_permission_debug "Permission system is disabled, skipping configuration"
  exit 0
fi

# Validate permissions settings
validate_permission_settings || exit 1

# Log current configuration when debugging is enabled
log_permission_debug "Permission debugging is enabled"
log_permission_debug "Permissions configuration loaded successfully"

# Export variables for child processes
export DEBUG_PERMISSIONS
